# FIAP Pós-Tech - Development Environment

Orquestração de microserviços com Docker para desenvolvimento local.

## Arquitetura

| Serviço | Porta | Stack | Database |
|---------|-------|-------|----------|
| **Auth** | 3002 | Node.js + Keycloak | PostgreSQL (interno) |
| **Main API** | 3001 | Node.js + Prisma | PostgreSQL :5432 |
| **Sale API** | 3003 | Node.js + Prisma | PostgreSQL :5434 |

## Quick Start

```bash
# 1. Setup inicial
make setup && make setup-all

# 2. Start services
./setup-network.sh

# 3. Database setup
make migrate-api && make seed-api
make migrate-api-sale

# 4. Verify
make health-all
```

**Endpoints:**
- Auth: http://localhost:3002/api-docs
- Main API: http://localhost:3001/api-docs  
- Sale API: http://localhost:3003/api-docs
- Keycloak: http://localhost:8080 (admin/admin)

## Authentication Flow

Todas as rotas (exceto `/health`) requerem JWT Bearer token.

**Solução:**
```bash
# Register
POST http://localhost:3002/auth/register
Content-Type: application/json

{
  "cpf": "12345678901",
  "password": "Pass123!",
  "email": "dev@example.com",
  "firstName": "John",
  "lastName": "Doe"
}

# Login
POST http://localhost:3002/auth/login
Content-Type: application/json

{
  "cpf": "12345678901",
  "password": "Pass123!"
}

# Use token
GET http://localhost:3001/api/v1/customers
Authorization: Bearer {access_token}
```

## Make Commands

### Global
```bash
make help           # List all commands
make status-all     # Container status
make health-all     # Health check all services
make up-all         # Start all
make down-all       # Stop all
make reset          # Remove volumes + reset
```

### Per Service
```bash
# Auth
make up-auth logs-auth test-auth shell-auth

# Main API  
make up-api logs-api migrate-api seed-api studio-api test-api shell-api

# Sale API
make up-api-sale logs-api-sale migrate-api-sale studio-api-sale test-api-sale shell-api-sale
```

## Database Schema Differences

| Entity | Main API | Sale API | Notes |
|--------|----------|----------|-------|
| Customer | ✅ Write | ✅ Read | Synced via webhook |
| Vehicle | ✅ Write | ✅ Read | Synced via webhook |
| Sale | ❌ | ✅ Write/Read | Sale API only |

**Sale API enums:**
- `SaleStatus`: PENDING, PAID, CANCELLED

## Troubleshooting

### Invalid Token (401)
**Issue:** APIs can't reach Keycloak for JWT validation

```bash
# Check Keycloak health
curl http://localhost:8080/health/ready

# Restart in correct order
make down-all
make up-auth
sleep 90  # Wait for Keycloak
make up-api up-api-sale
```

### Container Restart Loop
```bash
make logs-api  # Check logs
cd fiap-pos-tech-api
docker compose restart fiap-pos-tech-api-dev
```

### Migration Failures
```bash
# Restart database
cd fiap-pos-tech-api
docker compose restart fiap-pos-tech-api-db
sleep 5
make migrate-api
```

### Full Reset
```bash
make reset
make setup-all
./setup-network.sh
make migrate-api seed-api migrate-api-sale
```

## Environment Variables

Auto-generated by `make setup`. Key configurations:

**Main API (`fiap-pos-tech-api/.env`):**
```env
KEYCLOAK_URL=http://fiap-keycloak:8080
WEBHOOK_SECRET=your_webhook_secret
DATABASE_URL=postgresql://...
```

**Sale API (`fiap-pos-tech-api-sale/.env`):**
```env
KEYCLOAK_URL=http://fiap-keycloak:8080
MAIN_API_URL=http://fiap-pos-tech-api-dev:3001/api/v1
DATABASE_URL=postgresql://...
```

## Requirements

- Docker 20.10+
- Docker Compose v2
- Git
- Make

---

**FIAP Pós-Tech | Software Architecture**
